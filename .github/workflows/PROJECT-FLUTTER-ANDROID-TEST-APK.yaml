# ===================================================================
# Flutter Android í…ŒìŠ¤íŠ¸ìš© APK ë¹Œë“œ ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ê¸°ëŠ¥ ë¸Œëœì¹˜ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬
# í…ŒìŠ¤íŠ¸ìš© Android APKë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
#
# ì£¼ìš” íŠ¹ì§•:
# - workflow_dispatchë¡œ ìˆ˜ë™ ì‹¤í–‰ ë˜ëŠ” repository_dispatchë¡œ íŠ¸ë¦¬ê±°
# - ë²„ì „ ê´€ë¦¬ ë¶ˆí•„ìš” (AndroidëŠ” ë²„ì „ ì œì•½ ì—†ìŒ)
# - ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ìë™ ì¶”ì¶œ (YYYYMMDD_#ì´ìŠˆë²ˆí˜¸_ë‚´ìš© í˜•ì‹)
# - GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì™€ì„œ ë¹Œë“œ ì •ë³´ì— í¬í•¨
# - APK íŒŒì¼ë§Œ ìƒì„± (Play Store ë°°í¬ ì œê±°)
# - ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œí•˜ì—¬ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ (ìµœëŒ€ 500MB/ì•„í‹°íŒ©íŠ¸)
# - ì•„í‹°íŒ©íŠ¸ ì´ë¦„ì— ë¸Œëœì¹˜ëª… í¬í•¨í•˜ì—¬ êµ¬ë¶„ ìš©ì´
#
# ì‚¬ìš© ë°©ë²•:
# 1. ê¸°ëŠ¥ ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ
# 2. GitHub Actionsì—ì„œ ì´ ì›Œí¬í”Œë¡œìš° ì„ íƒ
# 3. "Run workflow" ë²„íŠ¼ í´ë¦­
# 4. ë¹Œë“œ ì™„ë£Œ í›„ ì•„í‹°íŒ©íŠ¸ì—ì„œ APK ë‹¤ìš´ë¡œë“œ
#
# ===================================================================
# ğŸ“‹ í•„ìš”í•œ GitHub Secrets
# ===================================================================
#
# ğŸ“ í™˜ê²½ ì„¤ì • (ì„ íƒ):
#   - ENV_FILE                  : .env íŒŒì¼ ë‚´ìš© (ì•±ì—ì„œ ì‚¬ìš©í•˜ëŠ” í™˜ê²½ë³€ìˆ˜)
#   - DEBUG_KEYSTORE            : debug.keystore íŒŒì¼ (base64 ì¸ì½”ë”©)
#   - GOOGLE_SERVICES_JSON      : google-services.json ë‚´ìš© (Firebase ì‚¬ìš© ì‹œ)
#
# ===================================================================

name: PROJECT-Flutter-Android-Test-APK

on:
  workflow_dispatch:
  repository_dispatch:
    types: [build-android-app]

# ============================================
# ğŸ”§ í”„ë¡œì íŠ¸ë³„ ì„¤ì • (ì•„ë˜ ê°’ë“¤ì„ ìˆ˜ì •í•˜ì„¸ìš”)
# ============================================
env:
  FLUTTER_VERSION: "3.35.5"
  JAVA_VERSION: "17"
  ENV_FILE_PATH: ".env"

jobs:
  prepare-test-build:
    name: í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì¤€ë¹„
    runs-on: ubuntu-latest

    outputs:
      issue_url: ${{ steps.issue_info.outputs.issue_url }}
      issue_title: ${{ steps.issue_info.outputs.issue_title }}
      issue_number: ${{ steps.issue_info.outputs.issue_number }}
      branch_name: ${{ steps.issue_info.outputs.branch_name }}
      branch_name_safe: ${{ steps.issue_info.outputs.branch_name_safe }}
      commit_hash: ${{ steps.build_info.outputs.commit_hash }}
      pr_number: ${{ steps.build_info.outputs.pr_number }}
      build_number: ${{ steps.build_info.outputs.build_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref }}

      - name: Pull latest changes
        run: |
          BRANCH_NAME="${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: $BRANCH_NAME"
          git pull origin "$BRANCH_NAME" || echo "âš ï¸ Pull ì‹¤íŒ¨ (ì´ë¯¸ ìµœì‹  ìƒíƒœì¼ ìˆ˜ ìˆìŒ)"

      # ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ ë° GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ì •ë³´ ì¶”ì¶œ
        id: issue_info
        run: |
          # repository_dispatchì¸ ê²½ìš° client_payloadì—ì„œ ë¸Œëœì¹˜ëª… ê°€ì ¸ì˜¤ê¸°
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            BRANCH_NAME="${{ github.event.client_payload.branch_name }}"
            ISSUE_NUMBER="${{ github.event.client_payload.issue_number }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
            # ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (#387 í˜•ì‹)
            ISSUE_NUMBER=$(echo "$BRANCH_NAME" | sed -n 's/.*#\([0-9]*\).*/\1/p')
          fi

          echo "ğŸŒ¿ ë¸Œëœì¹˜ëª…: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # ë¸Œëœì¹˜ëª…ì„ ì•„í‹°íŒ©íŠ¸ ì´ë¦„ì— ì‚¬ìš© ê°€ëŠ¥í•œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          # íŠ¹ìˆ˜ë¬¸ìë¥¼ ë°‘ì¤„ë¡œ ëŒ€ì²´
          BRANCH_NAME_SAFE=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9_-]/_/g' | cut -c1-50)
          echo "branch_name_safe=$BRANCH_NAME_SAFE" >> $GITHUB_OUTPUT

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âš ï¸ ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "issue_url=" >> $GITHUB_OUTPUT
            echo "issue_title=" >> $GITHUB_OUTPUT
            echo "issue_number=" >> $GITHUB_OUTPUT
          else
            echo "âœ… ì¶”ì¶œëœ ì´ìŠˆ ë²ˆí˜¸: #$ISSUE_NUMBER"
            ISSUE_URL="https://github.com/${{ github.repository }}/issues/$ISSUE_NUMBER"
            echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

            # GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ” GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ì¡°íšŒ ì¤‘..."
            ISSUE_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")

            ISSUE_TITLE=$(echo "$ISSUE_RESPONSE" | jq -r '.title // "ì´ìŠˆ ì •ë³´ ì—†ìŒ"')
            ISSUE_STATE=$(echo "$ISSUE_RESPONSE" | jq -r '.state // "unknown"')

            if [ "$ISSUE_TITLE" = "null" ] || [ "$ISSUE_TITLE" = "ì´ìŠˆ ì •ë³´ ì—†ìŒ" ]; then
              echo "âš ï¸ ì´ìŠˆ #$ISSUE_NUMBERë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "issue_title=" >> $GITHUB_OUTPUT
            else
              echo "ğŸ“‹ ì´ìŠˆ ì œëª©: $ISSUE_TITLE"
              echo "ğŸ“Œ ì´ìŠˆ ìƒíƒœ: $ISSUE_STATE"
              echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
            fi
          fi

      # ë¹Œë“œ ì •ë³´ ìƒì„±
      - name: ë¹Œë“œ ì •ë³´ ìƒì„±
        id: build_info
        run: |
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT=$(echo "$COMMIT_SHA" | cut -c1-7)
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')

          # repository_dispatch ì´ë²¤íŠ¸ì¸ ê²½ìš° PR ë²ˆí˜¸ë¥¼ ë¹Œë“œ ë²ˆí˜¸ë¡œ ì‚¬ìš©
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            BUILD_NUMBER="${{ github.event.client_payload.build_number }}"
            PR_NUMBER="${{ github.event.client_payload.pr_number }}"
            echo "ğŸ“‹ repository_dispatch ì´ë²¤íŠ¸ ê°ì§€"
            echo "  PR ë²ˆí˜¸: #$PR_NUMBER"
            echo "  ë¹Œë“œ ë²ˆí˜¸: $BUILD_NUMBER (PR ë²ˆí˜¸ ì‚¬ìš©)"
          else
            BUILD_NUMBER="${{ github.run_number }}"
            PR_NUMBER=""
            echo "ğŸ“‹ workflow_dispatch ì´ë²¤íŠ¸ ê°ì§€"
            echo "  ë¹Œë“œ ë²ˆí˜¸: $BUILD_NUMBER (ê¸°ë³¸ê°’)"
          fi

          echo "commit_hash=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ ë¹Œë“œ ì •ë³´:"
          echo "  ë¹Œë“œ ë²ˆí˜¸: #$BUILD_NUMBER"
          if [ -n "$PR_NUMBER" ]; then
            echo "  PR ë²ˆí˜¸: #$PR_NUMBER"
          fi
          echo "  ì»¤ë°‹ í•´ì‹œ: $COMMIT_SHORT"
          echo "  ë¹Œë“œ ë‚ ì§œ: $BUILD_DATE"

  build-android-test:
    name: Android í…ŒìŠ¤íŠ¸ APK ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: prepare-test-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref }}

      - name: Pull latest changes
        run: git pull origin ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}

      # Debug Keystore ì„¤ì • (ì„ íƒì )
      - name: Setup Debug Keystore
        run: |
          mkdir -p ~/.android
          if [ -n "${{ secrets.DEBUG_KEYSTORE }}" ]; then
            echo "${{ secrets.DEBUG_KEYSTORE }}" | base64 -d > ~/.android/debug.keystore
            echo "âœ… Debug Keystore created from secrets"
          else
            echo "â„¹ï¸ DEBUG_KEYSTORE secret not provided, using default"
          fi
          ls -la ~/.android/ || true

      # .env íŒŒì¼ ìƒì„±
      - name: Create .env file
        run: |
          cat << 'EOF' > ${{ env.ENV_FILE_PATH }}
          ${{ secrets.ENV_FILE }}
          EOF
          echo "âœ… ${{ env.ENV_FILE_PATH }} file created"

      # Keystoreì™€ key.properties ì„¤ì • (ì„ íƒì )
      - name: Setup Keystore and key.properties
        run: |
          mkdir -p android/app/keystore
          if [ -n "${{ secrets.DEBUG_KEYSTORE }}" ]; then
            echo "${{ secrets.DEBUG_KEYSTORE }}" | base64 -d > android/app/keystore/key.jks
            echo "âœ… Keystore created from DEBUG_KEYSTORE"
            echo "storeFile=keystore/key.jks" > android/key.properties
            echo "storePassword=android" >> android/key.properties
            echo "keyAlias=androiddebugkey" >> android/key.properties
            echo "keyPassword=android" >> android/key.properties
            echo "âœ… key.properties created"
          else
            echo "â„¹ï¸ DEBUG_KEYSTORE not provided, skipping keystore setup"
          fi
          ls -la android/ || true

      # google-services.json ìƒì„± (ì„ íƒì )
      - name: Create google-services.json
        run: |
          if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
            mkdir -p android/app
            cat << 'EOF' > android/app/google-services.json
          ${{ secrets.GOOGLE_SERVICES_JSON }}
          EOF
            echo "âœ… google-services.json created"
          else
            echo "â„¹ï¸ GOOGLE_SERVICES_JSON secret not provided, skipping"
          fi

      # Flutter ì„¤ì •
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Verify Flutter version
        run: |
          echo "âœ… Flutter setup completed"
          flutter --version

      # Flutter ë° Gradle ìºì‹œ
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          flutter pub get
          echo "âœ… Dependencies installed"

      # Gradle ì…‹ì—…
      - name: Setup Gradle
        working-directory: android
        run: |
          chmod +x gradlew
          echo "âœ… Gradle wrapper permissions set"

      # Java ì„¤ì •
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Verify Java version
        run: |
          echo "âœ… Java setup completed"
          java -version

      # Android SDK ì„¤ì •
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Verify Android SDK setup
        run: echo "âœ… Android SDK setup completed"

      # Ruby ì„¤ì •
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.1"
          bundler-cache: true

      - name: Verify Ruby version
        run: |
          echo "âœ… Ruby setup completed"
          ruby -v

      # Fastlane ì„¤ì¹˜
      - name: Install Fastlane
        run: |
          export GEM_HOME="$HOME/.gem"
          export GEM_PATH="$GEM_HOME"
          export PATH="$GEM_HOME/bin:$PATH"
          echo "GEM_HOME=$GEM_HOME" >> $GITHUB_ENV
          echo "GEM_PATH=$GEM_HOME" >> $GITHUB_ENV
          echo "$GEM_HOME/bin" >> $GITHUB_PATH
          gem install fastlane --no-document
          echo "âœ… Fastlane installed"
          fastlane --version

      # APK íŒŒì¼ëª… ìƒì„±
      - name: Generate APK filename
        id: apk_filename
        run: |
          COMMIT_SHORT="${{ needs.prepare-test-build.outputs.commit_hash }}"
          BUILD_NUMBER="${{ needs.prepare-test-build.outputs.build_number }}"
          APK_NAME="flutter-test-${BUILD_NUMBER}-${COMMIT_SHORT}.apk"
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ APK íŒŒì¼ëª…: $APK_NAME"

      # APK ë¹Œë“œ (Fastlane ë˜ëŠ” ì§ì ‘ ë¹Œë“œ)
      - name: Build APK
        run: |
          # Fastlane Fastfileì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì§ì ‘ ë¹Œë“œ
          if [ -f "android/fastlane/Fastfile" ]; then
            echo "ğŸ“¦ Fastlaneì„ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ..."
            cd android
            fastlane build --verbose || flutter build apk --release
          else
            echo "ğŸ“¦ Flutter ì§ì ‘ ë¹Œë“œ..."
            flutter build apk --release
          fi
          ls -la ./build/app/outputs/flutter-apk/ || true
          echo "âœ… APK built"

      # APK íŒŒì¼ ì´ë¦„ ë³€ê²½ ë° ì¤€ë¹„
      - name: Rename and Prepare APK
        run: |
          mkdir -p ./android/app/build/outputs/apk/release/
          APK_NAME="${{ steps.apk_filename.outputs.apk_name }}"
          mv ./build/app/outputs/flutter-apk/app-release.apk ./android/app/build/outputs/apk/release/${APK_NAME}
          echo "âœ… APK renamed to ${APK_NAME}"
          ls -la ./android/app/build/outputs/apk/release/

          # APK íŒŒì¼ í¬ê¸° í™•ì¸
          APK_SIZE=$(stat -c%s "./android/app/build/outputs/apk/release/${APK_NAME}" 2>/dev/null || stat -f%z "./android/app/build/outputs/apk/release/${APK_NAME}" 2>/dev/null || echo "0")
          APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc)
          echo "ğŸ“¦ APK íŒŒì¼ í¬ê¸°: ${APK_SIZE_MB}MB"

          # ì•„í‹°íŒ©íŠ¸ ìš©ëŸ‰ ì œí•œ í™•ì¸ (500MB)
          if [ "$APK_SIZE" -gt 524288000 ]; then
            echo "âš ï¸ ê²½ê³ : APK íŒŒì¼ í¬ê¸°ê°€ 500MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤ (${APK_SIZE_MB}MB)"
          else
            echo "âœ… APK íŒŒì¼ í¬ê¸°ê°€ ì•„í‹°íŒ©íŠ¸ ì œí•œ ë‚´ì…ë‹ˆë‹¤ (${APK_SIZE_MB}MB / 500MB)"
          fi

      # ë¹Œë“œ ì •ë³´ íŒŒì¼ ìƒì„±
      - name: Create build info file
        run: |
          BUILD_NUMBER="${{ needs.prepare-test-build.outputs.build_number }}"
          PR_NUMBER="${{ needs.prepare-test-build.outputs.pr_number }}"
          BRANCH_NAME="${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT="${{ needs.prepare-test-build.outputs.commit_hash }}"
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')

          cat > build-info.txt << EOF
          í…ŒìŠ¤íŠ¸ APK ë¹Œë“œ ì •ë³´

          ë¹Œë“œ ë²ˆí˜¸: #$BUILD_NUMBER
          EOF

          if [ -n "$PR_NUMBER" ]; then
            cat >> build-info.txt << EOF
          PR ë²ˆí˜¸: #$PR_NUMBER
          EOF
          fi

          cat >> build-info.txt << EOF
          ë¸Œëœì¹˜: $BRANCH_NAME
          ì»¤ë°‹: $COMMIT_SHORT
          ì „ì²´ ì»¤ë°‹ í•´ì‹œ: $COMMIT_SHA
          ë¹Œë“œ ë‚ ì§œ: $BUILD_DATE

          EOF

          # ì´ìŠˆ ì •ë³´ê°€ ìˆìœ¼ë©´ ì¶”ê°€
          if [ -n "${{ needs.prepare-test-build.outputs.issue_number }}" ]; then
            ISSUE_NUMBER="${{ needs.prepare-test-build.outputs.issue_number }}"
            ISSUE_TITLE="${{ needs.prepare-test-build.outputs.issue_title }}"
            ISSUE_URL="${{ needs.prepare-test-build.outputs.issue_url }}"

            cat >> build-info.txt << EOF
          ê´€ë ¨ ì´ìŠˆ:
          - #$ISSUE_NUMBER: $ISSUE_TITLE
          - URL: $ISSUE_URL

          EOF
          fi

          echo "ğŸ“‹ ë¹Œë“œ ì •ë³´ íŒŒì¼ ìƒì„± ì™„ë£Œ:"
          cat build-info.txt

      # ë¹Œë“œ ë©”íƒ€ë°ì´í„° íŒŒì¼ ìƒì„± (ëŒ“ê¸€ ì‘ì„± ì›Œí¬í”Œë¡œìš°ìš©)
      - name: Create build metadata file
        run: |
          cat > build-metadata.json << EOF
          {
            "pr_number": "${{ needs.prepare-test-build.outputs.pr_number }}",
            "build_number": "${{ needs.prepare-test-build.outputs.build_number }}",
            "issue_number": "${{ needs.prepare-test-build.outputs.issue_number }}",
            "branch_name": "${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}"
          }
          EOF
          cat build-metadata.json

      # APKì™€ ë¹Œë“œ ì •ë³´ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ (ë¸Œëœì¹˜ëª… í¬í•¨)
      - name: Upload APK and build info as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ needs.prepare-test-build.outputs.branch_name_safe }}-${{ needs.prepare-test-build.outputs.build_number }}
          path: |
            ./android/app/build/outputs/apk/release/*.apk
            build-info.txt
            build-metadata.json
          retention-days: 7
          if-no-files-found: error

      # ì„±ê³µ ì•Œë¦¼
      - name: Notify Build Success
        if: success()
        run: |
          echo "âœ… Android í…ŒìŠ¤íŠ¸ APK ë¹Œë“œ ì„±ê³µ!"
          echo "ë¹Œë“œ ë²ˆí˜¸: ${{ needs.prepare-test-build.outputs.build_number }}"
          if [ -n "${{ needs.prepare-test-build.outputs.pr_number }}" ]; then
            echo "PR ë²ˆí˜¸: ${{ needs.prepare-test-build.outputs.pr_number }}"
          fi
          echo "ë¸Œëœì¹˜: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}"
          echo "ì»¤ë°‹: ${{ needs.prepare-test-build.outputs.commit_hash }}"
          if [ -n "${{ needs.prepare-test-build.outputs.issue_url }}" ]; then
            echo "ê´€ë ¨ ì´ìŠˆ: ${{ needs.prepare-test-build.outputs.issue_url }}"
          fi
          echo ""
          echo "ğŸ“¦ ì•„í‹°íŒ©íŠ¸ì—ì„œ APK íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Android í…ŒìŠ¤íŠ¸ APK ë¹Œë“œ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."

      # PR/ISSUEì— ë¹Œë“œ ì™„ë£Œ ëŒ“ê¸€ ì‘ì„± (repository_dispatchë¡œ íŠ¸ë¦¬ê±°ëœ ê²½ìš°)
      - name: ë¹Œë“œ ì„±ê³µ ëŒ“ê¸€ ì‘ì„±
        if: success() && github.event_name == 'repository_dispatch' && github.event.client_payload.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sourceType = '${{ github.event.client_payload.source_type }}' || 'PR';
            const prNumber = parseInt('${{ github.event.client_payload.pr_number }}');
            const issueNumber = '${{ needs.prepare-test-build.outputs.issue_number }}';
            const buildNumber = '${{ needs.prepare-test-build.outputs.build_number }}';
            const commitHash = '${{ needs.prepare-test-build.outputs.commit_hash }}';
            const branchName = '${{ needs.prepare-test-build.outputs.branch_name }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            const artifactUrl = `${runUrl}#artifacts`;

            const body = `ğŸ¤– âœ… **Android í…ŒìŠ¤íŠ¸ APK ë¹Œë“œ ì™„ë£Œ**

            - ì•± ë²„ì „: \`0.0.0(${buildNumber})\`
            - ë¸Œëœì¹˜: \`${branchName}\`
            - ì»¤ë°‹: \`${commitHash}\`

            ğŸ“¦ **[ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ](${artifactUrl})**

            ğŸ”— [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë¡œê·¸](${runUrl})`;

            if (sourceType === 'PR') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log(`âœ… PR #${prNumber}ì— ë¹Œë“œ ì„±ê³µ ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ`);

              if (issueNumber && issueNumber !== '' && parseInt(issueNumber) !== prNumber) {
                const issueBody = `ğŸ¤– âœ… **Android í…ŒìŠ¤íŠ¸ APK ë¹Œë“œ ì™„ë£Œ**

            - ì•± ë²„ì „: \`0.0.0(${buildNumber})\`
            - ì»¤ë°‹: \`${commitHash}\`

            ğŸ“¦ **[ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ](${artifactUrl})**`;

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber),
                  body: issueBody
                });
                console.log(`âœ… ì´ìŠˆ #${issueNumber}ì—ë„ ë¹Œë“œ ì„±ê³µ ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ`);
              }
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log(`âœ… ${sourceType} #${prNumber}ì— ë¹Œë“œ ì„±ê³µ ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ`);
            }

      - name: ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„±
        if: failure() && github.event_name == 'repository_dispatch' && github.event.client_payload.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sourceType = '${{ github.event.client_payload.source_type }}' || 'PR';
            const prNumber = parseInt('${{ github.event.client_payload.pr_number }}');
            const issueNumber = '${{ needs.prepare-test-build.outputs.issue_number }}';
            const buildNumber = '${{ needs.prepare-test-build.outputs.build_number }}';
            const branchName = '${{ needs.prepare-test-build.outputs.branch_name }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const body = `ğŸ¤– âŒ **Android í…ŒìŠ¤íŠ¸ APK ë¹Œë“œ ì‹¤íŒ¨**

            - ì•± ë²„ì „: \`0.0.0(${buildNumber})\`
            - ë¸Œëœì¹˜: \`${branchName}\`

            âŒ ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

            ğŸ”— [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë¡œê·¸ í™•ì¸](${runUrl})`;

            if (sourceType === 'PR') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log(`âœ… PR #${prNumber}ì— ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ`);

              if (issueNumber && issueNumber !== '' && parseInt(issueNumber) !== prNumber) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber),
                  body: body
                });
                console.log(`âœ… ì´ìŠˆ #${issueNumber}ì—ë„ ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ`);
              }
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log(`âœ… ${sourceType} #${prNumber}ì— ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ`);
            }