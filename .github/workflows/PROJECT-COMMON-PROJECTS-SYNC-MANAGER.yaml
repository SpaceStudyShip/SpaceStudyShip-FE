# ===================================================================
# PROJECT-COMMON-PROJECTS-SYNC-MANAGER.yaml
# Issue Label â†’ GitHub Projects Status ë™ê¸°í™”
# ===================================================================
#
# GitHub Projects Status â†’ Issue Labelì€ Cloudflare Workerê°€ ë‹´ë‹¹í•©ë‹ˆë‹¤.
# (projects-sync-wizardë¡œ ì„¤ì •)
#
# ===================================================================
# ğŸ”‘ í•„ìˆ˜ GitHub Secrets
# ===================================================================
# _GITHUB_PAT_TOKEN: Projects APIìš© PAT (ê¶Œí•œ: repo, project)
# ===================================================================
#
# ğŸš€ ë¹ ë¥¸ ì‹œì‘:
# 1. _GITHUB_PAT_TOKEN Secret ì„¤ì •
# 2. ì•„ë˜ env ì„¹ì…˜ì˜ PROJECT_URL ì£¼ì„ í•´ì œ
# 3. GitHub Projects URL ì…ë ¥
# 4. ë!
#
# ì§€ì› URL í˜•ì‹:
# - Organization: https://github.com/orgs/{org}/projects/{number}
# - User: https://github.com/users/{user}/projects/{number}
# - /views/{id} ê²½ë¡œê°€ í¬í•¨ë˜ì–´ë„ ë©ë‹ˆë‹¤
#
# âš ï¸ Organization í”„ë¡œì íŠ¸ ì‚¬ìš© ì‹œ ì£¼ì˜ì‚¬í•­:
# - ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  ë ˆí¬ì— ë™ì¼í•œ Status Labelì´ í•„ìš”í•©ë‹ˆë‹¤
# - ë¼ë²¨ì€ .github/config/issue-labels.yml íŒŒì¼ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤
# - ìì„¸í•œ ë‚´ìš©: docs/PROJECTS-SYNC.md
#
# íŠ¸ë¦¬ê±°:
# - Issue Label ë³€ê²½ ì‹œ
# - ìˆ˜ë™ ì‹¤í–‰ (workflow_dispatch)
# ===================================================================

name: ğŸ”„ Projects Sync - Label to Status

on:
  issues:
    types: [labeled]

  workflow_dispatch:
    inputs:
      issue_number:
        description: 'ë™ê¸°í™”í•  Issue ë²ˆí˜¸'
        required: true
        type: string

concurrency:
  group: projects-sync-${{ github.event.issue.number || github.event.inputs.issue_number }}
  cancel-in-progress: true

env:
  # ë™ê¸°í™”í•  Status Label ëª©ë¡ (JSON ë°°ì—´)
  # projects-sync-wizardì—ì„œ ì„¤ì •í•œ ê°’ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤
  STATUS_LABELS: '["ì‘ì—…ì „", "ì‘ì—…ì¤‘", "ë‹´ë‹¹ìí™•ì¸", "í”¼ë“œë°±", "ì‘ì—…ì™„ë£Œ", "ë³´ë¥˜", "ì·¨ì†Œ"]'

  # ============================================
  # GitHub Projects ì—°ë™ ì„¤ì •
  #
  # ì‚¬ìš©í•˜ë ¤ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ê³  URLì„ ì…ë ¥í•˜ì„¸ìš”.
  #
  # ì§€ì› URL í˜•ì‹:
  # - Organization: https://github.com/orgs/{org}/projects/{number}
  # - User: https://github.com/users/{user}/projects/{number}
  # - /views/{id} ê²½ë¡œê°€ í¬í•¨ë˜ì–´ë„ ë©ë‹ˆë‹¤
  #
  # ì˜ˆì‹œ:
  # - https://github.com/orgs/MapSee-Lab/projects/1
  # - https://github.com/orgs/TEAM-ROMROM/projects/6/views/2
  # - https://github.com/users/Cassiiopeia/projects/2
  #
  # âš ï¸ Organization í”„ë¡œì íŠ¸ ì‚¬ìš© ì‹œ:
  # - ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  ë ˆí¬ì— ë™ì¼í•œ ë¼ë²¨ì´ í•„ìš”í•©ë‹ˆë‹¤
  # - .github/config/issue-labels.yml íŒŒì¼ë¡œ ë¼ë²¨ì„ ê´€ë¦¬í•˜ì„¸ìš”
  # - ìì„¸í•œ ë‚´ìš©: docs/PROJECTS-SYNC.md
  # ============================================
  # PROJECT_URL: 'https://github.com/orgs/YOUR-ORG/projects/1'

jobs:
  sync-label-to-status:
    runs-on: ubuntu-latest
    # ì¡°ê±´: Status Labelì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' &&
       contains(fromJSON('["ì‘ì—…ì „", "ì‘ì—…ì¤‘", "ë‹´ë‹¹ìí™•ì¸", "í”¼ë“œë°±", "ì‘ì—…ì™„ë£Œ", "ë³´ë¥˜", "ì·¨ì†Œ"]'), github.event.label.name))

    steps:
      - name: ğŸ” Get Issue Info
        id: issue
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "issue_number=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ Get Current Labels
        id: labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets._GITHUB_PAT_TOKEN }}
          script: |
            const statusLabels = JSON.parse(process.env.STATUS_LABELS);
            const issueNumber = parseInt('${{ steps.issue.outputs.issue_number }}');

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            // Status Label ì°¾ê¸°
            const currentStatusLabel = issue.labels
              .map(l => typeof l === 'string' ? l : l.name)
              .find(name => statusLabels.includes(name));

            if (currentStatusLabel) {
              core.setOutput('status_label', currentStatusLabel);
              console.log(`ğŸ“Œ í˜„ì¬ Status Label: ${currentStatusLabel}`);
            } else {
              core.setOutput('status_label', '');
              console.log('â­ï¸ Status Labelì´ ì—†ìŠµë‹ˆë‹¤.');
            }

      - name: ğŸ“‹ Update Projects Status
        if: steps.labels.outputs.status_label != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets._GITHUB_PAT_TOKEN }}
          script: |
            const statusLabel = '${{ steps.labels.outputs.status_label }}';
            const issueNumber = parseInt('${{ steps.issue.outputs.issue_number }}');

            // ============================================
            // URL íŒŒì‹± í•¨ìˆ˜
            // ============================================
            function parseProjectUrl(url) {
              if (!url) return null;

              // ì§€ì› íŒ¨í„´:
              // - https://github.com/orgs/{owner}/projects/{number}
              // - https://github.com/orgs/{owner}/projects/{number}/views/{view_id}
              // - https://github.com/users/{owner}/projects/{number}
              // - https://github.com/users/{owner}/projects/{number}/views/{view_id}
              const orgPattern = /github\.com\/orgs\/([^\/]+)\/projects\/(\d+)/;
              const userPattern = /github\.com\/users\/([^\/]+)\/projects\/(\d+)/;

              let match = url.match(orgPattern);
              if (match) {
                return {
                  type: 'organization',
                  owner: match[1],
                  number: parseInt(match[2])
                };
              }

              match = url.match(userPattern);
              if (match) {
                return {
                  type: 'user',
                  owner: match[1],
                  number: parseInt(match[2])
                };
              }

              return null;
            }

            // ============================================
            // í”„ë¡œì íŠ¸ URL íŒŒì‹±
            // ============================================
            const projectUrl = process.env.PROJECT_URL;

            if (!projectUrl) {
              console.log('âš ï¸ PROJECT_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              console.log('   ì›Œí¬í”Œë¡œìš° í™˜ê²½ ë³€ìˆ˜ì—ì„œ PROJECT_URL ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”.');
              console.log('');
              console.log('ğŸ’¡ ì§€ì› URL í˜•ì‹:');
              console.log('   - Organization: https://github.com/orgs/{org}/projects/{number}');
              console.log('   - User: https://github.com/users/{user}/projects/{number}');
              return;
            }

            const projectInfo = parseProjectUrl(projectUrl);

            if (!projectInfo) {
              console.log('âŒ PROJECT_URL í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
              console.log(`   ì…ë ¥ëœ URL: ${projectUrl}`);
              console.log('');
              console.log('ğŸ’¡ ì§€ì› URL í˜•ì‹:');
              console.log('   - Organization: https://github.com/orgs/{org}/projects/{number}');
              console.log('   - User: https://github.com/users/{user}/projects/{number}');
              console.log('   - /views/{id} ê²½ë¡œëŠ” í¬í•¨ë˜ì–´ë„ ë©ë‹ˆë‹¤');
              return;
            }

            const isOrgProject = projectInfo.type === 'organization';
            console.log(`ğŸ“Œ í”„ë¡œì íŠ¸ íƒ€ì…: ${isOrgProject ? 'Organization' : 'User'}`);
            console.log(`ğŸ“Œ ì†Œìœ ì: ${projectInfo.owner}`);
            console.log(`ğŸ“Œ í”„ë¡œì íŠ¸ ë²ˆí˜¸: ${projectInfo.number}`);
            console.log(`ğŸ“Œ Issue #${issueNumber} â†’ Status: "${statusLabel}"`);

            // ============================================
            // GraphQLë¡œ Project Item ID ì°¾ê¸°
            // ============================================
            const projectItemQuery = `
              query($owner: String!, $repo: String!, $issueNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issueNumber) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          number
                        }
                      }
                    }
                  }
                }
              }
            `;

            const projectItemResult = await github.graphql(projectItemQuery, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issueNumber: issueNumber
            });

            const projectItems = projectItemResult.repository?.issue?.projectItems?.nodes || [];
            const targetItem = projectItems.find(item =>
              item.project.number === projectInfo.number
            );

            if (!targetItem) {
              console.log('â­ï¸ ì´ìŠˆê°€ í•´ë‹¹ í”„ë¡œì íŠ¸ì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
              console.log(`   í”„ë¡œì íŠ¸ ë²ˆí˜¸: ${projectInfo.number}`);
              console.log('');
              console.log('ğŸ’¡ í•´ê²° ë°©ë²•:');
              console.log('   1. GitHub Projectsì—ì„œ ì´ìŠˆë¥¼ í”„ë¡œì íŠ¸ì— ì¶”ê°€í•˜ì„¸ìš”.');
              console.log('   2. ë˜ëŠ” ì´ìŠˆ ì‚¬ì´ë“œë°”ì—ì„œ "Projects"ë¥¼ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.');
              return;
            }

            console.log(`ğŸ“Œ Project Item ID: ${targetItem.id}`);

            // ============================================
            // Project í•„ë“œ ì •ë³´ ì¡°íšŒ (Organization vs User)
            // ============================================
            const orgProjectQuery = `
              query($owner: String!, $projectNumber: Int!) {
                organization(login: $owner) {
                  projectV2(number: $projectNumber) {
                    id
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;

            const userProjectQuery = `
              query($owner: String!, $projectNumber: Int!) {
                user(login: $owner) {
                  projectV2(number: $projectNumber) {
                    id
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;

            const projectQuery = isOrgProject ? orgProjectQuery : userProjectQuery;

            let projectResult;
            try {
              projectResult = await github.graphql(projectQuery, {
                owner: projectInfo.owner,
                projectNumber: projectInfo.number
              });
            } catch (error) {
              console.log('âŒ í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              console.log(`   ì—ëŸ¬: ${error.message}`);
              console.log('');
              console.log('ğŸ’¡ í™•ì¸ ì‚¬í•­:');
              console.log('   1. PROJECT_URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
              console.log('   2. _GITHUB_PAT_TOKENì— í”„ë¡œì íŠ¸ ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
              console.log('   3. í”„ë¡œì íŠ¸ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
              return;
            }

            const projectV2 = isOrgProject
              ? projectResult.organization?.projectV2
              : projectResult.user?.projectV2;

            if (!projectV2) {
              console.log('âŒ í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              console.log(`   ì†Œìœ ì: ${projectInfo.owner}`);
              console.log(`   í”„ë¡œì íŠ¸ ë²ˆí˜¸: ${projectInfo.number}`);
              return;
            }

            const statusField = projectV2.field;
            if (!statusField) {
              console.log('âŒ í”„ë¡œì íŠ¸ì—ì„œ Status í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              console.log('');
              console.log('ğŸ’¡ í•´ê²° ë°©ë²•:');
              console.log('   1. GitHub Projectsì—ì„œ "Status" í•„ë“œê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
              console.log('   2. í•„ë“œ ì´ë¦„ì´ ì •í™•íˆ "Status"ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
              return;
            }

            const targetOption = statusField.options.find(opt => opt.name === statusLabel);
            if (!targetOption) {
              console.log(`âŒ í”„ë¡œì íŠ¸ì— "${statusLabel}" Status ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.`);
              console.log('');
              console.log('ğŸ’¡ í˜„ì¬ í”„ë¡œì íŠ¸ì˜ Status ì˜µì…˜:');
              statusField.options.forEach(opt => {
                console.log(`   - ${opt.name}`);
              });
              console.log('');
              console.log('ğŸ’¡ í•´ê²° ë°©ë²•:');
              console.log('   1. GitHub Projectsì—ì„œ Status ì˜µì…˜ì„ ì¶”ê°€í•˜ì„¸ìš”.');
              console.log('   2. ë˜ëŠ” ì›Œí¬í”Œë¡œìš°ì˜ STATUS_LABELSë¥¼ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.');
              return;
            }

            console.log(`ğŸ“Œ Status Option ID: ${targetOption.id}`);

            // ============================================
            // Status ì—…ë°ì´íŠ¸
            // ============================================
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: {
                      singleSelectOptionId: $optionId
                    }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;

            try {
              await github.graphql(updateMutation, {
                projectId: projectV2.id,
                itemId: targetItem.id,
                fieldId: statusField.id,
                optionId: targetOption.id
              });

              console.log(`âœ… Statusê°€ "${statusLabel}"(ìœ¼)ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
              console.log('âŒ Status ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              console.log(`   ì—ëŸ¬: ${error.message}`);
            }
